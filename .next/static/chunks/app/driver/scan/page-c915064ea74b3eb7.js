(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[383],{2958:(e,t,a)=>{Promise.resolve().then(a.bind(a,5581))},5581:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>f});var l=a(8045),n=a(2731),i=a(5177),r=a(1209);function s(e){let t=e.getContext("2d"),a=t.getImageData(0,0,e.width,e.height),l=a.data;for(let e=0;e<l.length;e+=4){var n,i,r;let t=null!=(n=l[e])?n:0,a=.299*t+.587*(null!=(i=l[e+1])?i:0)+.114*(null!=(r=l[e+2])?r:0);l[e]=l[e+1]=l[e+2]=a}return t.putImageData(a,0,0),e}function o(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:185,a=e.getContext("2d"),l=a.getImageData(0,0,e.width,e.height),n=l.data;for(let e=0;e<n.length;e+=4){var i;let a=255*((null!=(i=n[e])?i:0)>t);n[e]=n[e+1]=n[e+2]=a}return a.putImageData(l,0,0),e}async function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1600,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,l=window.cv;if(!l)throw Error("OpenCV not loaded");let n=l.imread(e),i=new l.Mat;l.cvtColor(n,i,l.COLOR_RGBA2GRAY,0),l.GaussianBlur(i,i,new l.Size(5,5),0,0,l.BORDER_DEFAULT);let r=new l.Mat;l.Canny(i,r,50,150);let s=l.Mat.ones(3,3,l.CV_8U);l.dilate(r,r,s);let o=new l.MatVector,c=new l.Mat;l.findContours(r,o,c,l.RETR_EXTERNAL,l.CHAIN_APPROX_SIMPLE);let d=null,h=n.rows*n.cols;for(let e=0;e<o.size();e++){let t=o.get(e),a=l.arcLength(t,!0),n=new l.Mat;if(l.approxPolyDP(t,n,.02*a,!0),4===n.rows&&l.isContourConvex(n)){let e=n.data32S,t=[{x:e[0],y:e[1]},{x:e[2],y:e[3]},{x:e[4],y:e[5]},{x:e[6],y:e[7]}];t.sort((e,t)=>e.y-t.y);let a=t[0],l=t[1],i=t[2],r=t[3],[s,o]=a.x<l.x?[a,l]:[l,a],[c,u]=i.x<r.x?[i,r]:[r,i],x=Math.hypot(o.x-s.x,o.y-s.y),g=Math.hypot(u.x-c.x,u.y-c.y),m=Math.hypot(c.x-s.x,c.y-s.y),f=(x+g)/2/Math.max(1,(m+Math.hypot(u.x-o.x,u.y-o.y))/2),p=Math.abs(s.x*o.y-o.x*s.y+o.x*u.y-u.x*o.y+u.x*c.y-c.x*u.y+c.x*s.y-s.x*c.y)/2,w=p/h,y=w>.2&&w<.95;f>1.2&&f<1.9&&y&&(!d||p>d.area)&&(d={pts:[s.x,s.y,o.x,o.y,u.x,u.y,c.x,c.y],area:p,ratio:f})}n.delete()}if(!d)return i.delete(),r.delete(),o.delete(),c.delete(),s.delete(),n.delete(),e;let u=l.matFromArray(4,1,l.CV_32FC2,new Float32Array(d.pts)),x=l.matFromArray(4,1,l.CV_32FC2,new Float32Array([0,0,t,0,t,a,0,a])),g=l.getPerspectiveTransform(u,x),m=new l.Mat;l.warpPerspective(n,m,g,new l.Size(t,a),l.INTER_LINEAR,l.BORDER_CONSTANT,new l.Scalar);let f=document.createElement("canvas");return f.width=t,f.height=a,l.imshow(f,m),n.delete(),i.delete(),r.delete(),o.delete(),c.delete(),s.delete(),u.delete(),x.delete(),g.delete(),m.delete(),f}let d={};function h(e,t,a){let l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8,n=d[e]||[],i=t.split("").map((e,t)=>{var l;return{c:e,conf:null!=(l=null==a?void 0:a[t])?l:1}});n.push(i),n.length>l&&n.shift(),d[e]=n;let r=n.length?Math.max(...n.map(e=>e.length)):0,s="";for(let e=0;e<r;e++){var o;let t=n.map(t=>t[e]).filter(Boolean);if(!t.length)continue;let a=new Map;for(let{c:e,conf:l}of t)a.set(e,(null!=(o=a.get(e))?o:0)+l);let l=[...a.entries()].sort((e,t)=>t[1]-e[1])[0];l&&(s+=l[0])}return s}function u(e){e?delete d[e]:Object.keys(d).forEach(e=>delete d[e])}let x=["Manitoba","Ontario","Saskatchewan","Alberta","British Columbia","Quebec","Nova Scotia","New Brunswick","Newfoundland and Labrador","Prince Edward Island","Yukon","Nunavut","Northwest Territories","California","New York","Texas","Florida","Washington"];function g(){let e=(0,i.useRef)(null),[t,a]=(0,i.useState)(!1),[n,d]=(0,i.useState)(null),[g,f]=(0,i.useState)(null),[p,w]=(0,i.useState)(null),y=(0,i.useRef)(null);async function v(){return y.current||(y.current=await (0,r.createWorker)("eng",1,{logger:()=>{}})),y.current}function N(e){let t=x.map(t=>[t,e.toLowerCase().indexOf(t.toLowerCase())]).filter(e=>{let[,t]=e;return t>=0}).sort((e,t)=>t[0].length-e[0].length)[0];return null==t?void 0:t[0]}async function b(){if(e.current){a(!0),w(null),u();try{var t,l,n,i,r,x,g,m,p;let a=[];for(let t=0;t<5;t++){let l,n=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1600,a=(e.videoWidth||1600)/(e.videoHeight||1e3),l=Math.min(t,e.videoWidth||t),n=Math.round(l/a),i=document.createElement("canvas");return i.width=l,i.height=n,i.getContext("2d").drawImage(e,0,0,l,n),i}(e.current,1600);try{l=await c(n,1600,1e3)}catch(e){l=n}0===t&&f(l.toDataURL("image/png"));let i=s(l);i=o(i,185),a.push(i),await new Promise(e=>setTimeout(e,120))}let d=a[0];if(!d)throw Error("No frames captured");let u=await v(),A=d.toDataURL("image/png");await u.setParameters({tessedit_pageseg_mode:"6"});let j=(await u.recognize(A,{rotateAuto:!0})).data.words||[],L=e=>{let t=j.find(t=>e.test(t.text));if(!t)return null;let{x0:a,y0:l,x1:n,y1:i}=t.bbox;return{x0:a,y0:l,x1:n,y1:i}},D=L(/^(DOB|Date of Birth|Naissance|N[ée]\s? le)$/i),R=L(/^(EXP|Expiry|Expires|Expiration|Expire|Date d['’]expiration)$/i),S=L(/^(CLASS|CL|Classe|Cat[ée]gorie)$/i),I=L(/^(DL|LIC|Licence|License|No\.?|N[oº]\.?|Num[eé]ro)$/i),O=d.width,P=d.height;function y(e,t){return e?{x:Math.min(t-1,e.x1+8),y:Math.max(0,e.y0-8),w:Math.min(Math.floor(.45*t),t-(e.x1+8)),h:Math.max(24,e.y1-e.y0+16)}:null}function b(e,t,a){return e?{x:Math.max(0,e.x0-8),y:Math.min(a-1,e.y1+6),w:Math.min(Math.floor(.6*t),t-(e.x0-8)),h:Math.max(24,Math.floor(.08*a))}:null}let U=y(D,O),B=b(D,O,P),T=y(R,O),Y=b(R,O,P),Z=y(S,O),k=b(S,O,P),F=y(I,O),V=b(I,O,P),W={};async function C(e,t,a){if(!t)return{text:"",confs:[]};let l=document.createElement("canvas");l.width=t.w,l.height=t.h;let n=l.getContext("2d");if(!n)return{text:"",confs:[]};n.drawImage(e,t.x,t.y,t.w,t.h,0,0,t.w,t.h);let i=l.toDataURL("image/png");await u.setParameters(a);let r=await u.recognize(i,{rotateAuto:!1}),s=(r.data.text||"").replace(/\n/g," ").trim(),o=(r.data.symbols||[]).map(e=>{var t;return null!=(t=e.confidence)?t:1});return{text:s,confs:o}}function M(e){return e.length?e.reduce((e,t)=>e+t,0)/e.length:0}function E(e,t,a,l,n){let i=(e.match(n)||[]).join("").length,r=(a.match(n)||[]).join("").length;return i!==r?i>r?{text:e,confs:t}:{text:a,confs:l}:M(t)>=M(l)?{text:e,confs:t}:{text:a,confs:l}}for(let e of a){{let t=await C(e,F,{tessedit_pageseg_mode:"7",tessedit_char_whitelist:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-"}),a=await C(e,V,{tessedit_pageseg_mode:"7",tessedit_char_whitelist:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-"}),{text:l,confs:n}=E(t.text,t.confs,a.text,a.confs,/[A-Z0-9-]/g),i=(l||"").replace(/[^A-Z0-9-]/gi,"");i&&(W.licenseNo=h("licenseNo",i))}{let t=await C(e,U,{tessedit_pageseg_mode:"7",tessedit_char_whitelist:"0123456789/-. "}),a=await C(e,B,{tessedit_pageseg_mode:"7",tessedit_char_whitelist:"0123456789/-. "}),i=null!=(n=null==(l=E(t.text,t.confs,a.text,a.confs,/[0-9/\-.]/g).text.match(/(\d{4}[\/\-.]\d{2}[\/\-.]\d{2}|(?:\d{1,2}[\/\-.]){2}\d{2,4})/))?void 0:l[1])?n:"";i&&(W.dob=h("dob",i))}{let t=await C(e,T,{tessedit_pageseg_mode:"7",tessedit_char_whitelist:"0123456789/-. "}),a=await C(e,Y,{tessedit_pageseg_mode:"7",tessedit_char_whitelist:"0123456789/-. "}),l=null!=(r=null==(i=E(t.text,t.confs,a.text,a.confs,/[0-9/\-.]/g).text.match(/(\d{4}[\/\-.]\d{2}[\/\-.]\d{2}|(?:\d{1,2}[\/\-.]){2}\d{2,4})/))?void 0:i[1])?r:"";l&&(W.licenseExpiry=h("licenseExpiry",l))}{let t=await C(e,Z,{tessedit_pageseg_mode:"7",tessedit_char_whitelist:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"}),a=await C(e,k,{tessedit_pageseg_mode:"7",tessedit_char_whitelist:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"}),{text:l}=E(t.text,t.confs,a.text,a.confs,/[A-Z0-9]/g),n=(null!=(g=null==(x=l.match(/[A-Z0-9]{1,3}/))?void 0:x[0])?g:"").toUpperCase();n&&(W.licenseClass=h("licenseClass",n))}}{await u.setParameters({tessedit_pageseg_mode:"6"});let e=(await u.recognize(d.toDataURL("image/png"),{rotateAuto:!1})).data.text||"",t=N(e);t&&(W.issuingAuthority=t);let a=e.split(/\r?\n/).map(e=>e.trim()).filter(Boolean),l=e=>e.replace(/[^A-Z\s\-']/g,"").length/Math.max(1,e.length)>.6;for(let e=0;e<Math.min(8,a.length-1);e++){let t=null!=(m=a[e])?m:"",n=null!=(p=a[e+1])?p:"";if(l(t)&&l(n)&&t.length>2&&n.length>2){W.legalName="".concat(t," ").concat(n);break}}}w({legalName:null==(t=W.legalName)?void 0:t.replace(/\s+/g," ").trim(),licenseNo:W.licenseNo,dob:_(W.dob),licenseExpiry:_(W.licenseExpiry),issuingAuthority:W.issuingAuthority,licenseClass:W.licenseClass})}catch(e){d(e instanceof Error?e.message:"Extraction failed. Improve lighting and try again.")}finally{a(!1)}}}async function C(e){let t,a=new Image;a.src=URL.createObjectURL(e),await a.decode();let l=document.createElement("canvas");l.width=a.width,l.height=a.height;let n=l.getContext("2d");if(!n)return;n.drawImage(a,0,0);try{t=await c(l,1600,1e3)}catch(e){t=l}f(t.toDataURL("image/png"));let i=s(t);i=o(i,185),await M(i)}async function M(e){a(!0),w(null),u();try{var t,l,n,i;let a=await v();await a.setParameters({tessedit_pageseg_mode:"6"});let c=await a.recognize(e.toDataURL("image/png"),{rotateAuto:!0}),d=c.data.words||[],h=e=>{let t=d.find(t=>e.test(t.text));if(!t)return null;let{x0:a,y0:l,x1:n,y1:i}=t.bbox;return{x0:a,y0:l,x1:n,y1:i}},u=h(/^(DOB|Date of Birth|Naissance|N[ée]\s? le)$/i),x=h(/^(EXP|Expiry|Expires|Expiration|Expire|Date d['’]expiration)$/i),g=h(/^(CLASS|CL|Classe|Cat[ée]gorie)$/i),m=h(/^(DL|LIC|Licence|License|No\.?|N[oº]\.?|Num[eé]ro)$/i),f=e.width,p=e.height;function r(e,t){return e?{x:Math.min(t-1,e.x1+8),y:Math.max(0,e.y0-8),w:Math.min(Math.floor(.45*t),t-(e.x1+8)),h:Math.max(24,e.y1-e.y0+16)}:null}function s(e,t,a){return e?{x:Math.max(0,e.x0-8),y:Math.min(a-1,e.y1+6),w:Math.min(Math.floor(.6*t),t-(e.x0-8)),h:Math.max(24,Math.floor(.08*a))}:null}let y=r(u,f),b=s(u,f,p),C=r(x,f),M=s(x,f,p),E=r(g,f),A=s(g,f,p),j=r(m,f),L=s(m,f,p),D=async(e,t)=>{await a.setParameters({tessedit_pageseg_mode:e,tessedit_char_whitelist:t})};async function o(t,l,n){if(!t)return{text:"",confs:[]};let i=document.createElement("canvas");i.width=t.w,i.height=t.h;let r=i.getContext("2d");if(!r)return{text:"",confs:[]};r.drawImage(e,t.x,t.y,t.w,t.h,0,0,t.w,t.h);let s=i.toDataURL("image/png");await D(l,n);let o=await a.recognize(s,{rotateAuto:!1}),c=(o.data.text||"").replace(/\n/g," ").trim(),d=(o.data.symbols||[]).map(e=>{var t;return null!=(t=e.confidence)?t:1});return{text:c,confs:d}}let R=await o(j,"7","ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-"),S=await o(L,"7","ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-"),{text:I}=(()=>{let e=(R.text.match(/[A-Z0-9-]/g)||[]).length,t=(S.text.match(/[A-Z0-9-]/g)||[]).length;return e>=t?R:S})(),O=await o(y,"7","0123456789/-. "),P=await o(b,"7","0123456789/-. "),U=(()=>{let e=(O.text.match(/[0-9/\-.]/g)||[]).length,t=(P.text.match(/[0-9/\-.]/g)||[]).length;return e>=t?O.text:P.text})(),B=await o(C,"7","0123456789/-. "),T=await o(M,"7","0123456789/-. "),Y=(()=>{let e=(B.text.match(/[0-9/\-.]/g)||[]).length,t=(T.text.match(/[0-9/\-.]/g)||[]).length;return e>=t?B.text:T.text})(),Z=await o(E,"7","ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"),k=await o(A,"7","ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"),F=(()=>{let e=(Z.text.match(/[A-Z0-9]/g)||[]).length,t=(k.text.match(/[A-Z0-9]/g)||[]).length;return e>=t?Z.text:k.text})(),V=c.data.text||"",W=N(V),X=function(e){let t=e.split(/\r?\n/).map(e=>e.trim()).filter(Boolean),a=e=>e.replace(/[^A-Z\s\-']/g,"").length/Math.max(1,e.length)>.6;for(let e=0;e<Math.min(8,t.length-1);e++){var l,n;let i=null!=(l=t[e])?l:"",r=null!=(n=t[e+1])?n:"";if(a(i)&&a(r)&&i.length>2&&r.length>2)return"".concat(i," ").concat(r).replace(/\s+/g," ").trim()}return t.find(e=>a(e)&&e.length>3)||""}(V),G=null!=(n=null==(t=Y.match(/(\d{4}[\/\-.]\d{2}[\/\-.]\d{2}|(?:\d{1,2}[\/\-.]){2}\d{2,4})/))?void 0:t[1])?n:"",$=null!=(i=null==(l=U.match(/(\d{4}[\/\-.]\d{2}[\/\-.]\d{2}|(?:\d{1,2}[\/\-.]){2}\d{2,4})/))?void 0:l[1])?i:"";w({legalName:X,licenseNo:(I||"").replace(/[^A-Z0-9-]/gi,""),dob:_($),licenseExpiry:_(G),issuingAuthority:W,licenseClass:(F||"").toUpperCase()})}catch(e){d(e instanceof Error?e.message:"Extraction failed.")}finally{a(!1)}}function _(e){var t,a,l,n,i,r;if(!e)return e;if(e.match(/^\d{4}[\/\-.]\d{2}[\/\-.]\d{2}$/))return e.replace(/[\/.]/g,"-");let s=e.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/);if(s){let e=null!=(t=s[1])?t:"",n=null!=(a=s[2])?a:"",i=null!=(l=s[3])?l:"",r=2===i.length?+i>30?"19".concat(i):"20".concat(i):i;return"".concat((null!=r?r:"").padStart(4,"0"),"-").concat(e.padStart(2,"0"),"-").concat(n.padStart(2,"0"))}let o=e.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/);if(o){let e=null!=(n=o[1])?n:"",t=null!=(i=o[2])?i:"",a=null!=(r=o[3])?r:"",l=2===a.length?+a>30?"19".concat(a):"20".concat(a):a;return"".concat((null!=l?l:"").padStart(4,"0"),"-").concat(t.padStart(2,"0"),"-").concat(e.padStart(2,"0"))}return e}return(0,i.useEffect)(()=>{let t=e.current;return(async()=>{try{let e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});t&&(t.srcObject=e,await t.play())}catch(e){d("Camera unavailable or denied. Use the upload option below.")}})(),()=>{let e=null==t?void 0:t.srcObject;null==e||e.getTracks().forEach(e=>e.stop()),(async()=>{y.current&&await y.current.terminate()})(),u()}},[]),(0,l.jsxs)("div",{className:"space-y-6",children:[(0,l.jsxs)("div",{className:"relative mx-auto aspect-[3/2] w-full max-w-md overflow-hidden rounded border border-slate-300 bg-black",children:[(0,l.jsx)("video",{ref:e,className:"h-full w-full object-cover",playsInline:!0,muted:!0}),(0,l.jsx)("div",{className:"pointer-events-none absolute inset-0 m-6 rounded-md border-2 border-emerald-400/70"})]}),(0,l.jsxs)("div",{className:"flex items-center gap-3",children:[(0,l.jsx)("button",{onClick:b,disabled:t,className:"rounded bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700 disabled:opacity-50",children:t?"Extracting…":"Capture & Extract (wallet-style)"}),(0,l.jsxs)("label",{className:"text-sm text-slate-700",children:["or upload a photo",(0,l.jsx)("input",{type:"file",accept:"image/*",className:"ml-3 inline-block text-sm",onChange:e=>{var t;let a=null==(t=e.target.files)?void 0:t[0];a&&C(a)}})]})]}),n&&(0,l.jsx)("p",{className:"text-sm text-rose-600","aria-live":"polite",children:n}),g&&(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-medium text-slate-700",children:"Rectified preview used for OCR"}),(0,l.jsx)("img",{src:g,alt:"Captured preview",className:"mt-2 max-h-56 rounded border border-slate-200"})]}),p&&(0,l.jsxs)("div",{className:"rounded border border-slate-200 p-4",children:[(0,l.jsx)("h3",{className:"mb-2 text-base font-semibold",children:"Extracted Fields (editable)"}),(0,l.jsxs)("div",{className:"grid gap-3 sm:grid-cols-2",children:[(0,l.jsx)(m,{label:"Name",value:p.legalName||"",onChange:e=>w({...p,legalName:e})}),(0,l.jsx)(m,{label:"Licence #",value:p.licenseNo||"",onChange:e=>w({...p,licenseNo:e})}),(0,l.jsx)(m,{label:"DOB (YYYY-MM-DD)",value:p.dob||"",onChange:e=>w({...p,dob:e})}),(0,l.jsx)(m,{label:"Expiry (YYYY-MM-DD)",value:p.licenseExpiry||"",onChange:e=>w({...p,licenseExpiry:e})}),(0,l.jsx)(m,{label:"Issuing authority",value:p.issuingAuthority||"",onChange:e=>w({...p,issuingAuthority:e})})]}),(0,l.jsx)("p",{className:"mt-3 text-xs text-slate-600",children:"Tip: If anything looks off, edit it here before saving."})]})]})}function m(e){let{label:t,value:a,onChange:n}=e;return(0,l.jsxs)("label",{className:"block",children:[(0,l.jsx)("span",{className:"block text-sm text-slate-700",children:t}),(0,l.jsx)("input",{className:"mt-1 w-full rounded border border-slate-300 p-2",value:a,onChange:e=>n(e.target.value)})]})}function f(){return(0,l.jsxs)("main",{className:"mx-auto max-w-3xl px-4 py-8",children:[(0,l.jsx)(n.default,{src:"https://docs.opencv.org/4.x/opencv.js",strategy:"afterInteractive"}),(0,l.jsxs)("header",{className:"mb-6",children:[(0,l.jsx)("h1",{className:"text-2xl font-semibold text-slate-900",children:"Scan your licence (front)"}),(0,l.jsx)("p",{className:"text-slate-600",children:"On-device extraction of your name, licence number, date of birth, expiry, and issuing authority. Nothing is uploaded."}),(0,l.jsxs)("ul",{className:"mt-2 list-disc pl-5 text-sm text-slate-600",children:[(0,l.jsx)("li",{children:"Place the card inside the frame; reduce glare."}),(0,l.jsxs)("li",{children:["Tap ",(0,l.jsx)("b",{children:"Capture & Extract"})," or upload a photo."]}),(0,l.jsx)("li",{children:"Review & edit the extracted fields."})]})]}),(0,l.jsx)(g,{})]})}}},e=>{e.O(0,[131,986,143,358],()=>e(e.s=2958)),_N_E=e.O()}]);